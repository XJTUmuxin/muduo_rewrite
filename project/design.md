# 文件夹同步应用

## 基本功能

1) 实现中心化的文件夹同步，在服务器端创建共享文件夹，来为多个客户端的目标文件夹提供同步服务
2) 实现实时的同步，当某个客户端的目标文件夹发生改动，实时的将该改动扩散到所有客户端
3) 客户端在启动应用时实现初始化，将目标文件夹同步为服务器端共享文件夹相同的状态

## 实现原理

### 服务器端
服务器的网络通信和文件传输通过muduo网络库来实现。服务器一直监听建立连接的客户端，当客户端文件夹发生变化时，会向服务器发送改动消息，之后对服务器的共享文件夹进行改动，同时通知其余客户端，来和共享文件夹实现同步。

### 客户端
客户端的网络通信和文件传输也通过muduo网络库来实现。同时，客户端一直通过linux的inotif机制监听目标文件夹，当监听到目标文件夹发生变化时，通知服务器端进行同步。

### 消息设计

一共两类消息，分为命令消息和数据消息

1)命令消息，用于传递同步所需要的命令，例如 请求同步，请求文件，删除文件，移动文件等

2)数据消息，用于传输文件，当传送文件时，会将文件分块传输，每块数据打包成消息发送

#### 命令消息

命令消息对应的json结构为：

```json
{
  "type":"command",
  "command": 具体命令，例如请求文件
  "content": 命令具体内容，例如文件路径
}
```


命令设计：

1) requestSyn：表示一方向另一方请求同步
    
    content为FileNode的序列化结果，表示请求方的文件结构

    ```json
    {
      "name":文件名称，
      "isDir":是否为文件夹，
      "m_time":最后修改时间，
      "children":{
                    "size":子目录和文件个数
                    "1":第一个子节点
                    ...
                  }
    }
    ```
2) delete：表示一方要求另一方删除文件或子文件夹
    
    content格式为
    ```json
    {
      ""
    }
    ```
    
3) move：表示一方要求另一方移动文件或子文件夹


4) get: 表示一方向另一方请求文件
  
  content为：
  {
    "path":filePath
  }

5) post: 表示一方向另一方上传文件

  content为：
  {
    "path":filePath，
    "isDir": is dir
  }


#### 数据消息

数据消息对应的json结构为:
{
  'type':'data',
  'path': 文件路径,
  'size': 文件大小,
  'm_time': 最后修改时间,
  'content': 文件块具体内容
}
